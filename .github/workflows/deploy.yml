name: Auto Deploy to EC2 (with Rollback and Safe Env)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/ec2_key ubuntu@${{ secrets.EC2_PUBLIC_IP }} "
            set -e

            cd ~/chat_app

            echo '--- Ensuring env folder exists ---'
            mkdir -p env

            echo '--- Backing up current version ---'
            rm -rf chat_app_prev
            cp -r chat_app chat_app_prev || true

            echo '--- Updating source code ---'
            cd chat_app
            git reset --hard
            git pull origin main

            echo '--- Copy envs into build context ---'
            cp ../env/backend.env ./backend/.env
            cp ../env/frontend.env ./frontend/.env

            echo '--- Stopping running containers ---'
            sudo docker compose down || true

            echo '--- Building new containers ---'
            if ! sudo docker compose up -d --build; then
              echo ' Build failed â€” Rolling back...'

              sudo docker compose down || true
              cd ~/chat_app

              rm -rf chat_app
              mv chat_app_prev chat_app

              echo '--- Starting rollback containers ---'
              cd chat_app
              sudo docker compose up -d

              exit 1
            fi

            echo '--- Cleaning Docker trash ---'
            sudo docker system prune -af || true

            echo ' Deployment complete!'
          "
