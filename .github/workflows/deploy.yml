name: Auto Deploy to EC2 (with Rollback and Safe Env)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/ec2_key ubuntu@${{ secrets.EC2_PUBLIC_IP }} "
            set -e

            cd ~/chat_app

            echo '--- Ensuring env folder exists (safe from deletion) ---'
            mkdir -p env

            echo '--- Backing up previous version (ONLY code, NOT env) ---'
            rm -rf app_prev
            cp -r app app_prev || true

            echo '--- Updating source code ---'
            cd app
            git reset --hard
            git pull origin main

            echo '--- Stopping running containers ---'
            sudo docker compose down || true

            echo '--- Building new containers ---'
            if ! sudo docker compose up -d --build; then
              echo ' Build failed â€” Rolling back...'

              sudo docker compose down || true
              cd ~/chat_app

              rm -rf app
              mv app_prev app

              echo '--- Starting rollback container ---'
              cd app
              sudo docker compose up -d

              exit 1
            fi

            echo '--- Cleaning Docker trash ---'
            sudo docker system prune -af || true

            echo ' Deployment complete!'
          "
